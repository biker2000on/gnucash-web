---
phase: 01-foundation
plan: 05
type: execute
wave: 4
depends_on: [01-04]
files_modified: [src/app/api/splits/bulk/reconcile/route.ts, src/app/api/commodities/route.ts, src/lib/db.ts]
autonomous: true

must_haves:
  truths:
    - "All functional API routes are migrated to Prisma"
    - "Legacy db.ts can be safely removed or minimized"
  artifacts:
    - path: "src/app/api/commodities/route.ts"
      provides: "Commodities via Prisma"
  key_links:
    - from: "src/app/api/splits/bulk/reconcile/route.ts"
      to: "src/lib/prisma.ts"
      via: "import"
---

<objective>
Migrate the remaining API routes to Prisma and clean up legacy database connection code.

Purpose: Complete the ORM migration across the entire application.
Output: Fully Prisma-backed API and removed legacy dependencies.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Remaining API Routes</name>
  <files>src/app/api/commodities/route.ts, src/app/api/splits/bulk/reconcile/route.ts, src/app/api/accounts/[guid]/transactions/route.ts</files>
  <action>
    Migrate all remaining API routes found in src/app/api/ to use Prisma.
    Pay special attention to routes using the account_hierarchy view or complex Joins.
  </action>
  <verify>All API endpoints respond correctly</verify>
  <done>Entire API layer is migrated to Prisma.</done>
</task>

<task type="auto">
  <name>Task 2: Final Cleanup and Deprecation</name>
  <files>src/lib/db.ts, package.json</files>
  <action>
    1. Check if src/lib/db.ts is still needed (e.g., for view initialization).
    2. If not needed for queries, remove pg dependency and query exports.
    3. Update any remaining references.
  </action>
  <verify>Project builds without errors</verify>
  <done>Legacy pg connection code is removed or minimized.</done>
</task>

</tasks>

<verification>
Run npm run build to ensure the entire project compiles correctly with Prisma.
</verification>

<success_criteria>
The application is fully migrated to Prisma and legacy pg queries are removed.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
