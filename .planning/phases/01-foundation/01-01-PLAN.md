---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [package.json, prisma/schema.prisma, src/lib/prisma.ts]
autonomous: true

must_haves:
  truths:
    - "Prisma schema reflects the GnuCash PostgreSQL structure"
    - "Prisma client is successfully generated"
    - "Prisma singleton provides access to the database with extensions"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "GnuCash database model definitions"
    - path: "src/lib/prisma.ts"
      provides: "Singleton Prisma client with extension support"
  key_links:
    - from: "src/lib/prisma.ts"
      to: "@prisma/client"
      via: "instantiation"
---

<objective>
Set up Prisma ORM and introspect the existing GnuCash database schema.

Purpose: Move from raw SQL queries to a type-safe ORM while preserving the legacy database structure.
Output: Valid Prisma schema, generated client, and a singleton instance for app-wide use.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Prisma and Initial Introspection</name>
  <files>package.json, prisma/schema.prisma</files>
  <action>
    1. Install prisma and @prisma/client.
    2. Initialize prisma: npx prisma init.
    3. Introspect existing database: npx prisma db pull.
    4. Verify DATABASE_URL in .env.local is used.
  </action>
  <verify>npx prisma validate</verify>
  <done>prisma/schema.prisma contains GnuCash tables like accounts, transactions, splits.</done>
</task>

<task type="auto">
  <name>Task 2: Refine Schema and Generate Client</name>
  <files>prisma/schema.prisma</files>
  <action>
    1. Review introspected models.
    2. Add @@map and @map attributes to ensure PascalCase model names while keeping snake_case table/column names.
    3. Ensure BigInt (INT8) fields are correctly mapped.
    4. Run npx prisma generate.
  </action>
  <verify>npx prisma generate succeeds without errors</verify>
  <done>Generated Prisma Client is available for import.</done>
</task>

<task type="auto">
  <name>Task 3: Create Prisma Singleton</name>
  <files>src/lib/prisma.ts</files>
  <action>
    Create src/lib/prisma.ts following the singleton pattern from research.
    Ensure it handles Next.js Hot Module Replacement (HMR) by using globalThis.
    Leave a placeholder for the fraction-to-decimal extension (to be implemented in Plan 03).
  </action>
  <verify>File exists and exports a prisma instance</verify>
  <done>Prisma singleton is ready for use in the application.</done>
</task>

</tasks>

<verification>
Check that npx prisma validate passes.
Verify that src/lib/prisma.ts is correctly exported.
</verification>

<success_criteria>
Prisma is initialized and can connect to the GnuCash database.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
