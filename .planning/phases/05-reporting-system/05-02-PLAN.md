---
phase: 05-reporting-system
plan: 02
type: execute
wave: 2
depends_on: [05-01-PLAN.md]
files_modified: [src/app/(main)/reports/balance-sheet/page.tsx, src/app/(main)/reports/income-statement/page.tsx, src/app/(main)/reports/cash-flow/page.tsx, src/app/api/reports/balance-sheet/route.ts, src/app/api/reports/income-statement/route.ts, src/app/api/reports/cash-flow/route.ts, src/components/reports/BalanceSheet.tsx, src/components/reports/IncomeStatement.tsx, src/components/reports/CashFlow.tsx]
autonomous: true

must_haves:
  truths:
    - "Balance Sheet shows Assets, Liabilities, Equity with correct totals"
    - "Income Statement shows Revenue, Expenses, Net Income"
    - "Cash Flow shows operating, investing, financing activities"
    - "All reports respect date range filters"
  artifacts:
    - path: "src/components/reports/BalanceSheet.tsx"
      provides: "Balance sheet report"
    - path: "src/components/reports/IncomeStatement.tsx"
      provides: "P&L report"
    - path: "src/components/reports/CashFlow.tsx"
      provides: "Cash flow statement"
  key_links:
    - from: "src/app/(main)/reports/balance-sheet/page.tsx"
      to: "/api/reports/balance-sheet"
      via: "fetch"
---

<objective>
Implement core financial statements.

Purpose: Provide standard financial reports (Balance Sheet, P&L, Cash Flow).
Output: Three complete financial statements with correct calculations.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/05-reporting-system/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Create Balance Sheet API and Component</name>
  <files>src/app/api/reports/balance-sheet/route.ts, src/components/reports/BalanceSheet.tsx, src/app/(main)/reports/balance-sheet/page.tsx</files>
  <action>
    API (GET):
    - Accept asOfDate parameter
    - Query all accounts with cumulative balances up to date
    - Group by account type (ASSET, LIABILITY, EQUITY)
    - Calculate retained earnings (sum of income - expenses before date)
    - Return structured data with totals

    Component:
    - Two-column layout: Assets | Liabilities + Equity
    - Hierarchical account display with indentation
    - Subtotals for each section
    - Grand totals with Assets = Liabilities + Equity check
    - Comparison column if compare date provided

    Page:
    - Wrap in ReportViewer
    - Fetch data on filter change
    - Default to end of current month
  </action>
  <verify>Balance Sheet shows correct totals, Assets = L + E</verify>
  <done>Balance Sheet report complete.</done>
</task>

<task type="auto">
  <name>Create Income Statement API and Component</name>
  <files>src/app/api/reports/income-statement/route.ts, src/components/reports/IncomeStatement.tsx, src/app/(main)/reports/income-statement/page.tsx</files>
  <action>
    API (GET):
    - Accept startDate, endDate parameters
    - Query income and expense accounts for period
    - Calculate gross revenue, total expenses, net income
    - Support comparison period

    Component:
    - Revenue section with accounts
    - Expenses section with accounts
    - Gross Profit line (if COGS accounts exist)
    - Net Income line
    - Comparison column with variance

    Page:
    - Wrap in ReportViewer
    - Default to current month
  </action>
  <verify>P&L shows revenue, expenses, correct net income</verify>
  <done>Income Statement report complete.</done>
</task>

<task type="auto">
  <name>Create Cash Flow API and Component</name>
  <files>src/app/api/reports/cash-flow/route.ts, src/components/reports/CashFlow.tsx, src/app/(main)/reports/cash-flow/page.tsx</files>
  <action>
    API (GET):
    - Accept startDate, endDate
    - Calculate using indirect method:
      1. Start with Net Income
      2. Operating: Changes in current assets/liabilities
      3. Investing: Changes in fixed assets
      4. Financing: Changes in debt/equity
    - Or direct method: Sum transactions in cash/bank accounts

    Component:
    - Three sections: Operating, Investing, Financing
    - Starting cash balance
    - Net change in cash
    - Ending cash balance

    Page:
    - Wrap in ReportViewer
    - Default to current month
  </action>
  <verify>Cash Flow shows correct beginning/ending cash</verify>
  <done>Cash Flow statement complete.</done>
</task>

</tasks>

<verification>
- Balance Sheet balances (A = L + E)
- P&L net income matches sum of income - expenses
- Cash Flow ending balance matches actual cash accounts
</verification>

<success_criteria>
Core financial statements accurately reflect GnuCash data.
</success_criteria>

<output>
After completion, create `.planning/phases/05-reporting-system/05-02-SUMMARY.md`
</output>
