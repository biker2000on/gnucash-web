---
phase: 03-enhanced-account-hierarchy
plan: 01
type: execute
wave: 1
depends_on: [02-04-PLAN.md]
files_modified: [src/app/api/accounts/route.ts, src/app/api/accounts/[guid]/route.ts, src/components/AccountForm.tsx, src/components/AccountHierarchy.tsx]
autonomous: true

must_haves:
  truths:
    - "User can create new accounts with valid GnuCash GUIDs"
    - "User can edit account name, description, code, and flags"
    - "User can delete accounts without transactions"
    - "Account form validates required fields"
  artifacts:
    - path: "src/components/AccountForm.tsx"
      provides: "Create/edit account form"
    - path: "src/app/api/accounts/route.ts"
      provides: "POST endpoint for account creation"
    - path: "src/app/api/accounts/[guid]/route.ts"
      provides: "PUT/DELETE endpoints for account operations"
  key_links:
    - from: "src/components/AccountHierarchy.tsx"
      to: "src/components/AccountForm.tsx"
      via: "modal trigger"
---

<objective>
Implement account CRUD operations.

Purpose: Allow users to create, edit, and delete accounts while maintaining GnuCash compatibility.
Output: Account form component and supporting API endpoints.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-enhanced-account-hierarchy/03-RESEARCH.md
@src/components/AccountHierarchy.tsx
</context>

<tasks>

<task type="auto">
  <name>Create Account API Endpoints</name>
  <files>src/app/api/accounts/route.ts, src/app/api/accounts/[guid]/route.ts</files>
  <action>
    1. Add POST handler to /api/accounts for account creation:
       - Generate 32-char hex GUID
       - Validate required fields (name, account_type, parent_guid)
       - Set defaults for commodity_scu (100), non_std_scu (0)
       - Return created account

    2. Add PUT handler to /api/accounts/[guid] for updates:
       - Allow updating: name, description, code, hidden, placeholder
       - Cannot change account_type or parent (separate endpoint)

    3. Add DELETE handler to /api/accounts/[guid]:
       - Check for zero splits referencing this account
       - Return 400 if account has transactions
       - Delete account if empty
  </action>
  <verify>Test with curl: create account, update it, delete it</verify>
  <done>API supports full account CRUD with validation.</done>
</task>

<task type="auto">
  <name>Create AccountForm Component</name>
  <files>src/components/AccountForm.tsx</files>
  <action>
    Create a reusable form component for account creation/editing:
    - Name field (required)
    - Account type dropdown (ASSET, LIABILITY, INCOME, EXPENSE, EQUITY, etc.)
    - Parent account selector (hierarchical dropdown)
    - Code field (optional, for account numbers)
    - Description field (optional)
    - Hidden checkbox
    - Placeholder checkbox (for parent-only accounts)
    - Currency/commodity selector (default to parent's commodity)

    Support both "create" and "edit" modes via props.
    Use controlled inputs with React state.
    Show validation errors inline.
  </action>
  <verify>Form renders, validates, submits without errors</verify>
  <done>AccountForm supports create and edit modes with validation.</done>
</task>

<task type="auto">
  <name>Integrate Form into AccountHierarchy</name>
  <files>src/components/AccountHierarchy.tsx</files>
  <action>
    1. Add "New Account" button in header that opens AccountForm in modal
    2. Add context menu or action button on each account node:
       - Edit: Opens AccountForm in edit mode
       - Delete: Shows confirmation, calls DELETE API
       - New Child: Opens AccountForm with parent pre-selected
    3. Refresh account list after successful operations
  </action>
  <verify>Can create child account, edit existing, delete empty account</verify>
  <done>Account hierarchy supports full CRUD via integrated form.</done>
</task>

</tasks>

<verification>
- Create new account under existing parent
- Edit account name and description
- Cannot delete account with transactions
- Can delete empty account
</verification>

<success_criteria>
Account CRUD operations work correctly with GnuCash-compatible data.
</success_criteria>

<output>
After completion, create `.planning/phases/03-enhanced-account-hierarchy/03-01-SUMMARY.md`
</output>
