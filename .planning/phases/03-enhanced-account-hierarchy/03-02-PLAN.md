---
phase: 03-enhanced-account-hierarchy
plan: 02
type: execute
wave: 2
depends_on: [03-01-PLAN.md]
files_modified: [src/components/AccountHierarchy.tsx, src/components/DraggableAccountNode.tsx, src/app/api/accounts/[guid]/move/route.ts]
autonomous: true

must_haves:
  truths:
    - "User can drag accounts to new parent positions"
    - "Circular references are prevented"
    - "Account type compatibility is validated"
    - "Visual feedback shows valid drop targets"
  artifacts:
    - path: "src/components/DraggableAccountNode.tsx"
      provides: "DnD-enabled account tree node"
    - path: "src/app/api/accounts/[guid]/move/route.ts"
      provides: "Endpoint for hierarchy changes"
  key_links:
    - from: "src/components/AccountHierarchy.tsx"
      to: "@dnd-kit/core"
      via: "DndContext provider"
---

<objective>
Implement drag-drop reorganization of account hierarchy.

Purpose: Allow users to restructure their chart of accounts through intuitive drag-drop.
Output: DnD-enabled tree with server-side validation.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/03-enhanced-account-hierarchy/03-RESEARCH.md
@src/components/AccountHierarchy.tsx
</context>

<tasks>

<task type="auto">
  <name>Install DnD Dependencies</name>
  <files>package.json</files>
  <action>
    Install @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities
  </action>
  <verify>npm install succeeds, packages in node_modules</verify>
  <done>DnD libraries installed.</done>
</task>

<task type="auto">
  <name>Create Move Account API</name>
  <files>src/app/api/accounts/[guid]/move/route.ts</files>
  <action>
    Create PUT endpoint that:
    1. Accepts newParentGuid in request body
    2. Validates no circular reference (check ancestor chain)
    3. Validates account type compatibility:
       - Root accounts can only be under Root
       - ASSET/LIABILITY/INCOME/EXPENSE/EQUITY can be nested within same type
    4. Updates parent_guid
    5. Returns updated account

    Return 400 with specific error for:
    - Circular reference detected
    - Incompatible account types
  </action>
  <verify>Test moving account to valid and invalid parents</verify>
  <done>Move API validates and executes hierarchy changes.</done>
</task>

<task type="auto">
  <name>Create DraggableAccountNode Component</name>
  <files>src/components/DraggableAccountNode.tsx</files>
  <action>
    Create a wrapper component using @dnd-kit:
    1. Use useDraggable for drag source
    2. Use useDroppable for drop target
    3. Show visual indicators:
       - Dragging: Reduced opacity, shadow
       - Valid drop: Green highlight
       - Invalid drop: Red highlight or no highlight
    4. Pass drag data: { accountGuid, accountType }
  </action>
  <verify>Account node can be dragged and shows proper states</verify>
  <done>Draggable node component with visual feedback.</done>
</task>

<task type="auto">
  <name>Integrate DnD into AccountHierarchy</name>
  <files>src/components/AccountHierarchy.tsx</files>
  <action>
    1. Wrap tree in DndContext from @dnd-kit/core
    2. Replace AccountNode with DraggableAccountNode
    3. Handle onDragEnd:
       - Get dragged account and drop target
       - Call move API
       - Refresh tree on success
       - Show error toast on failure
    4. Implement drop validation logic client-side for immediate feedback
  </action>
  <verify>Can drag account to new parent, tree updates</verify>
  <done>Full drag-drop account reorganization working.</done>
</task>

</tasks>

<verification>
- Drag ASSET account under another ASSET account
- Cannot drag account to be child of itself
- Cannot drag root-level account under non-root
- Tree updates after successful move
</verification>

<success_criteria>
Users can reorganize accounts via drag-drop with proper validation.
</success_criteria>

<output>
After completion, create `.planning/phases/03-enhanced-account-hierarchy/03-02-SUMMARY.md`
</output>
