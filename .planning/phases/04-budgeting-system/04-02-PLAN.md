---
phase: 04-budgeting-system
plan: 02
type: execute
wave: 2
depends_on: [04-01-PLAN.md]
files_modified: [src/app/(main)/budgets/[guid]/page.tsx, src/components/BudgetEditor.tsx, src/app/api/budgets/[guid]/amounts/route.ts]
autonomous: true

must_haves:
  truths:
    - "User can edit budget amounts in spreadsheet-style grid"
    - "Grid shows accounts as rows, periods as columns"
    - "Changes are saved automatically or on explicit save"
    - "Row totals and column totals are displayed"
  artifacts:
    - path: "src/components/BudgetEditor.tsx"
      provides: "Spreadsheet-style budget editor"
    - path: "src/app/(main)/budgets/[guid]/page.tsx"
      provides: "Budget editor page"
  key_links:
    - from: "src/components/BudgetEditor.tsx"
      to: "/api/budgets/[guid]/amounts"
      via: "batch update fetch"
---

<objective>
Implement spreadsheet-style budget editor.

Purpose: Allow users to enter and modify budget amounts efficiently.
Output: Grid editor with virtualization for large budgets.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/04-budgeting-system/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Install Grid Dependencies</name>
  <files>package.json</files>
  <action>
    Install @tanstack/react-table and @tanstack/react-virtual for efficient grid rendering.
  </action>
  <verify>npm install succeeds</verify>
  <done>Grid dependencies installed.</done>
</task>

<task type="auto">
  <name>Create Budget Amounts API</name>
  <files>src/app/api/budgets/[guid]/amounts/route.ts</files>
  <action>
    GET: Return all amounts for budget, grouped by account
    PUT: Batch update amounts
    - Accept array of { accountGuid, periodNum, value }
    - Upsert each amount
    - Return updated amounts
  </action>
  <verify>API correctly fetches and updates amounts</verify>
  <done>Budget amounts API functional.</done>
</task>

<task type="auto">
  <name>Create BudgetEditor Component</name>
  <files>src/components/BudgetEditor.tsx</files>
  <action>
    Build spreadsheet-style editor:
    1. First column: Account names (hierarchical indentation)
    2. Period columns: Jan, Feb, Mar... or Q1, Q2... or Year 1...
    3. Last column: Row total
    4. Last row: Column totals

    Features:
    - Editable cells with number input
    - Tab navigation between cells
    - Copy/paste support
    - Row virtualization for performance
    - Keyboard shortcuts (Enter to confirm, Escape to cancel)
    - Visual feedback on edit (cell background change)

    Data flow:
    - Load initial data from API
    - Track changes locally
    - Save button or auto-save with debounce
  </action>
  <verify>Grid renders, can edit cells, changes persist</verify>
  <done>BudgetEditor provides spreadsheet editing.</done>
</task>

<task type="auto">
  <name>Create Budget Editor Page</name>
  <files>src/app/(main)/budgets/[guid]/page.tsx</files>
  <action>
    1. Fetch budget and amounts on load
    2. Display budget name and metadata
    3. Render BudgetEditor with data
    4. Add save/cancel buttons
    5. Add "Back to Budgets" navigation
  </action>
  <verify>Page loads budget, allows editing, saves changes</verify>
  <done>Budget editor page complete.</done>
</task>

</tasks>

<verification>
- Grid displays accounts and periods correctly
- Can edit individual cells
- Tab navigates between cells
- Changes are saved to database
- Totals calculate correctly
</verification>

<success_criteria>
Budget editor allows efficient data entry like a spreadsheet.
</success_criteria>

<output>
After completion, create `.planning/phases/04-budgeting-system/04-02-SUMMARY.md`
</output>
