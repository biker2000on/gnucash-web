---
phase: 04-budgeting-system
plan: 03
type: execute
wave: 3
depends_on: [04-02-PLAN.md]
files_modified: [src/components/BudgetVsActual.tsx, src/app/api/budgets/[guid]/comparison/route.ts, src/app/(main)/budgets/[guid]/comparison/page.tsx]
autonomous: true

must_haves:
  truths:
    - "User can view budget vs actual comparison"
    - "Variance (over/under) is calculated and displayed"
    - "Visual indicators show budget status (on track, over, under)"
    - "Comparison can be viewed by period or YTD"
  artifacts:
    - path: "src/components/BudgetVsActual.tsx"
      provides: "Budget vs actual comparison view"
    - path: "src/app/api/budgets/[guid]/comparison/route.ts"
      provides: "Comparison data API"
  key_links:
    - from: "src/components/BudgetVsActual.tsx"
      to: "recharts"
      via: "chart rendering"
---

<objective>
Implement budget vs actual comparison and reports.

Purpose: Allow users to track actual spending against budget.
Output: Comparison view with variance analysis and charts.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/04-budgeting-system/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Install Chart Dependencies</name>
  <files>package.json</files>
  <action>
    Install recharts for budget visualization.
  </action>
  <verify>npm install succeeds</verify>
  <done>Chart library installed.</done>
</task>

<task type="auto">
  <name>Create Comparison API</name>
  <files>src/app/api/budgets/[guid]/comparison/route.ts</files>
  <action>
    GET endpoint that:
    1. Accepts periodNum or range (startPeriod, endPeriod)
    2. Fetches budget amounts for specified periods
    3. Calculates actual amounts from transactions
    4. Computes variance (actual - budget)
    5. Returns merged data with percentages

    Response format:
    {
      accounts: [
        {
          guid, name, type,
          budget, actual, variance, percentUsed
        }
      ],
      totals: { budget, actual, variance }
    }
  </action>
  <verify>API returns correct comparison data</verify>
  <done>Comparison API provides budget vs actual data.</done>
</task>

<task type="auto">
  <name>Create BudgetVsActual Component</name>
  <files>src/components/BudgetVsActual.tsx</files>
  <action>
    Create comparison view with:
    1. Period selector (dropdown or slider)
    2. Table view:
       - Account name
       - Budget amount
       - Actual amount
       - Variance (+ or -)
       - % of budget used (progress bar)
    3. Color coding:
       - Green: Under budget (<90%)
       - Yellow: Near budget (90-100%)
       - Red: Over budget (>100%)
    4. Bar chart: Budget vs Actual by account
    5. Summary card: Total budget, total actual, net variance
  </action>
  <verify>Component displays comparison correctly</verify>
  <done>BudgetVsActual shows variance analysis.</done>
</task>

<task type="auto">
  <name>Create Comparison Page</name>
  <files>src/app/(main)/budgets/[guid]/comparison/page.tsx</files>
  <action>
    1. Page showing BudgetVsActual component
    2. Period navigation (prev/next or dropdown)
    3. YTD toggle (sum all periods up to current)
    4. Link from budget editor page
    5. Print-friendly layout option
  </action>
  <verify>Page shows comparison, periods navigate</verify>
  <done>Budget comparison page complete.</done>
</task>

</tasks>

<verification>
- Comparison shows correct budget and actual
- Variance calculations are accurate
- Color coding reflects budget status
- Period navigation works
</verification>

<success_criteria>
Users can track spending against budget with clear visualizations.
</success_criteria>

<output>
After completion, create `.planning/phases/04-budgeting-system/04-03-SUMMARY.md`
</output>
