---
phase: 06-supporting-features
plan: 01
type: execute
wave: 1
depends_on: [05-03-PLAN.md]
files_modified: [src/components/InvestmentAccount.tsx, src/app/api/accounts/[guid]/valuation/route.ts, src/app/api/prices/route.ts, src/lib/commodities.ts]
autonomous: true

must_haves:
  truths:
    - "Investment accounts show current market value"
    - "Price history is displayed for commodities"
    - "Users can manually enter prices"
    - "Unrealized gain/loss is calculated"
  artifacts:
    - path: "src/components/InvestmentAccount.tsx"
      provides: "Investment account view with valuation"
    - path: "src/lib/commodities.ts"
      provides: "Commodity and price utilities"
  key_links:
    - from: "src/components/InvestmentAccount.tsx"
      to: "/api/accounts/[guid]/valuation"
      via: "fetch"
---

<objective>
Implement investment account support with commodity valuation.

Purpose: Allow users to track stock/fund portfolios with current market values.
Output: Investment views with real-time valuation and gain/loss calculations.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/06-supporting-features/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Create Commodity Utilities</name>
  <files>src/lib/commodities.ts</files>
  <action>
    Create utility functions:
    - getLatestPrice(commodityGuid, currencyGuid, asOfDate): Get most recent price
    - calculateShares(splits): Sum quantity_num/quantity_denom
    - calculateCostBasis(splits): Sum value_num/value_denom (purchase price)
    - calculateMarketValue(shares, price): Current value
    - calculateGainLoss(marketValue, costBasis): Unrealized gain/loss
    - calculateGainLossPercent(gain, costBasis): Percentage return
  </action>
  <verify>Utility functions calculate correctly</verify>
  <done>Commodity utilities available.</done>
</task>

<task type="auto">
  <name>Create Valuation API</name>
  <files>src/app/api/accounts/[guid]/valuation/route.ts</files>
  <action>
    GET endpoint that returns:
    - Account details and commodity info
    - Current shares held
    - Cost basis (total invested)
    - Latest price and date
    - Market value
    - Unrealized gain/loss (amount and %)
    - Price history (last 30 days)

    Accept asOfDate parameter for historical valuation.
  </action>
  <verify>API returns correct valuation data</verify>
  <done>Valuation API provides investment data.</done>
</task>

<task type="auto">
  <name>Create Prices API</name>
  <files>src/app/api/prices/route.ts, src/app/api/prices/[guid]/route.ts</files>
  <action>
    /api/prices:
    - GET: List prices for commodity (with pagination)
    - POST: Create new price entry (manual entry)

    /api/prices/[guid]:
    - GET: Get single price
    - PUT: Update price
    - DELETE: Delete price

    Validate: price must be positive, date required
  </action>
  <verify>CRUD operations work for prices</verify>
  <done>Price API supports manual entry.</done>
</task>

<task type="auto">
  <name>Create InvestmentAccount Component</name>
  <files>src/components/InvestmentAccount.tsx</files>
  <action>
    Create investment view showing:
    1. Header: Commodity name, ticker, last price
    2. Holdings summary:
       - Shares owned
       - Cost basis
       - Market value
       - Gain/Loss with % and color (green/red)
    3. Price chart (line chart of price history)
    4. Transaction history (buys/sells)
    5. Manual price entry button

    Use for accounts where commodity.namespace is not 'CURRENCY'
  </action>
  <verify>Component displays investment data correctly</verify>
  <done>InvestmentAccount shows portfolio valuation.</done>
</task>

<task type="auto">
  <name>Integrate into Account Ledger</name>
  <files>src/components/AccountLedger.tsx, src/app/(main)/accounts/[guid]/page.tsx</files>
  <action>
    1. Detect if account is investment (commodity.namespace !== 'CURRENCY')
    2. Show InvestmentAccount component instead of/above standard ledger
    3. Include lot tracking display (if supported by GnuCash data)
    4. Add "Add Price" button for manual price entry
  </action>
  <verify>Investment accounts show valuation view</verify>
  <done>Investment view integrated into accounts.</done>
</task>

</tasks>

<verification>
- Investment account shows current value
- Gain/loss calculates correctly
- Manual price entry works
- Price history displays in chart
</verification>

<success_criteria>
Investment accounts display meaningful portfolio data.
</success_criteria>

<output>
After completion, create `.planning/phases/06-supporting-features/06-01-SUMMARY.md`
</output>
