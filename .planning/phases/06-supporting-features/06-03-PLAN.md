---
phase: 06-supporting-features
plan: 03
type: execute
wave: 3
depends_on: [06-02-PLAN.md]
files_modified: [src/lib/auth.ts, src/app/api/auth/login/route.ts, src/app/api/auth/logout/route.ts, src/app/api/auth/register/route.ts, src/middleware.ts, src/components/LoginForm.tsx, src/app/login/page.tsx, prisma/schema.prisma]
autonomous: true

must_haves:
  truths:
    - "Users can register with username and password"
    - "Users can log in and maintain session"
    - "Protected routes require authentication"
    - "Audit trail records data changes"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "Authentication utilities"
    - path: "src/middleware.ts"
      provides: "Route protection middleware"
    - path: "src/app/login/page.tsx"
      provides: "Login page"
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/auth.ts"
      via: "session verification"
---

<objective>
Implement local user authentication and audit trail.

Purpose: Secure the application and track data changes.
Output: Login system with session management and audit logging.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/06-supporting-features/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Install Auth Dependencies</name>
  <files>package.json</files>
  <action>
    Install bcrypt, iron-session for authentication.
    Add @types/bcrypt as dev dependency.
  </action>
  <verify>npm install succeeds</verify>
  <done>Auth dependencies installed.</done>
</task>

<task type="auto">
  <name>Create Extension Tables</name>
  <files>prisma/schema.prisma</files>
  <action>
    Add models for extension tables (separate from GnuCash schema):

    model GnucashWebUser {
      id           Int      @id @default(autoincrement())
      username     String   @unique
      passwordHash String   @map("password_hash")
      createdAt    DateTime @default(now()) @map("created_at")
      lastLogin    DateTime? @map("last_login")
      auditLogs    GnucashWebAudit[]
      @@map("gnucash_web_users")
    }

    model GnucashWebAudit {
      id         Int      @id @default(autoincrement())
      userId     Int?     @map("user_id")
      action     String   // CREATE, UPDATE, DELETE
      entityType String   @map("entity_type")
      entityGuid String   @map("entity_guid") @db.Char(32)
      oldValues  Json?    @map("old_values")
      newValues  Json?    @map("new_values")
      createdAt  DateTime @default(now()) @map("created_at")
      user       GnucashWebUser? @relation(fields: [userId], references: [id])
      @@map("gnucash_web_audit")
    }

    Run: npx prisma db push (or migration)
  </action>
  <verify>Tables created in database</verify>
  <done>Extension tables available.</done>
</task>

<task type="auto">
  <name>Create Auth Utilities</name>
  <files>src/lib/auth.ts</files>
  <action>
    Create authentication functions:
    - hashPassword(password): Hash with bcrypt
    - verifyPassword(password, hash): Verify hash
    - createSession(userId): Create session cookie
    - getSession(req): Get current session
    - destroySession(req): Clear session
    - getCurrentUser(req): Get user from session

    Session config using iron-session:
    - Secure cookie
    - 24-hour expiry
    - HTTP-only
  </action>
  <verify>Auth functions work correctly</verify>
  <done>Auth utilities available.</done>
</task>

<task type="auto">
  <name>Create Auth API Routes</name>
  <files>src/app/api/auth/login/route.ts, src/app/api/auth/logout/route.ts, src/app/api/auth/register/route.ts, src/app/api/auth/me/route.ts</files>
  <action>
    /api/auth/register (POST):
    - Validate username/password
    - Check username not taken
    - Hash password and create user
    - Create session
    - Return user info

    /api/auth/login (POST):
    - Validate credentials
    - Verify password
    - Create session
    - Update lastLogin
    - Return user info

    /api/auth/logout (POST):
    - Destroy session
    - Return success

    /api/auth/me (GET):
    - Return current user or 401
  </action>
  <verify>Registration and login flow works</verify>
  <done>Auth API endpoints functional.</done>
</task>

<task type="auto">
  <name>Create Login Page and Form</name>
  <files>src/app/login/page.tsx, src/components/LoginForm.tsx</files>
  <action>
    Create login page:
    - Username field
    - Password field
    - Login button
    - Link to register
    - Error display
    - Redirect on success

    Create registration form:
    - Username field
    - Password field
    - Confirm password field
    - Register button
    - Password strength indicator
  </action>
  <verify>Login and registration UI works</verify>
  <done>Auth UI complete.</done>
</task>

<task type="auto">
  <name>Create Auth Middleware</name>
  <files>src/middleware.ts</files>
  <action>
    Create Next.js middleware that:
    - Checks for valid session on protected routes
    - Redirects to /login if no session
    - Allows public routes: /login, /api/auth/*
    - Passes user info to API routes

    Configure matcher for all routes except static assets.
  </action>
  <verify>Protected routes redirect when not logged in</verify>
  <done>Route protection working.</done>
</task>

<task type="auto">
  <name>Create Audit Trail</name>
  <files>src/lib/audit.ts</files>
  <action>
    Create audit logging function:
    - logAudit(userId, action, entityType, entityGuid, oldValues, newValues)

    Integrate into:
    - Transaction create/update/delete
    - Account create/update/delete
    - Budget changes

    Store changes as JSON for easy querying.
  </action>
  <verify>Audit logs created for data changes</verify>
  <done>Audit trail functional.</done>
</task>

<task type="auto">
  <name>Add User Menu to Layout</name>
  <files>src/app/(main)/layout.tsx, src/components/UserMenu.tsx</files>
  <action>
    Create UserMenu component:
    - Show username when logged in
    - Dropdown with: Profile, Audit Log, Logout
    - Login button when not logged in

    Add to main layout header.
  </action>
  <verify>User menu displays correctly</verify>
  <done>User menu integrated.</done>
</task>

</tasks>

<verification>
- Can register new user
- Can login with credentials
- Protected routes require auth
- Audit log shows data changes
</verification>

<success_criteria>
Application is secured with authentication and changes are tracked.
</success_criteria>

<output>
After completion, create `.planning/phases/06-supporting-features/06-03-SUMMARY.md`
</output>
