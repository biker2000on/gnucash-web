---
phase: 06-supporting-features
plan: 02
type: execute
wave: 2
depends_on: [06-01-PLAN.md]
files_modified: [src/lib/currency.ts, src/components/CurrencyConverter.tsx, src/app/api/exchange-rates/route.ts]
autonomous: true

must_haves:
  truths:
    - "Multi-currency accounts display correctly"
    - "Currency conversion uses GnuCash price data"
    - "Reports can be viewed in base currency"
    - "Exchange rates can be manually entered"
  artifacts:
    - path: "src/lib/currency.ts"
      provides: "Currency conversion utilities"
    - path: "src/components/CurrencyConverter.tsx"
      provides: "Currency conversion UI"
  key_links:
    - from: "src/lib/currency.ts"
      to: "prisma/price"
      via: "price lookups"
---

<objective>
Implement advanced multi-currency support.

Purpose: Allow users to view accounts and reports in any currency.
Output: Currency conversion utilities and exchange rate management.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/06-supporting-features/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Create Currency Utilities</name>
  <files>src/lib/currency.ts</files>
  <action>
    Create utility functions:
    - getBaseCurrency(): Get user's base currency (from book or config)
    - findExchangeRate(from, to, date): Find direct or triangulated rate
    - convertAmount(amount, from, to, date): Convert using exchange rate
    - getCurrencyChain(from, to): Get conversion path
    - getAllCurrencies(): List all currencies in use

    Handle edge cases:
    - Same currency (return 1.0)
    - No direct rate (try via USD or EUR)
    - No rate found (throw error with helpful message)
  </action>
  <verify>Currency conversion functions work correctly</verify>
  <done>Currency utilities available.</done>
</task>

<task type="auto">
  <name>Create Exchange Rates API</name>
  <files>src/app/api/exchange-rates/route.ts</files>
  <action>
    GET endpoint:
    - List all currency pairs with latest rates
    - Accept base currency parameter
    - Return rates relative to base

    POST endpoint:
    - Create new exchange rate entry
    - Validate currencies exist in commodities
    - Store in prices table with appropriate source

    Both use GnuCash prices table.
  </action>
  <verify>API returns and creates exchange rates</verify>
  <done>Exchange rates API functional.</done>
</task>

<task type="auto">
  <name>Create CurrencyConverter Component</name>
  <files>src/components/CurrencyConverter.tsx</files>
  <action>
    Create widget showing:
    - Amount input
    - From currency dropdown
    - To currency dropdown
    - Converted amount (read-only)
    - Rate display
    - Rate date

    Also create CurrencySelector component:
    - Dropdown of available currencies
    - Show currency code and name
    - Searchable
  </action>
  <verify>Converter calculates correctly</verify>
  <done>Currency converter UI available.</done>
</task>

<task type="auto">
  <name>Add Currency Toggle to Reports</name>
  <files>src/components/reports/ReportFilters.tsx, src/components/reports/ReportViewer.tsx</files>
  <action>
    1. Add "Display Currency" selector to ReportFilters
    2. Pass selected currency to report APIs
    3. Convert all amounts to selected currency
    4. Show original and converted amounts (tooltip)
    5. Add rate date disclaimer
  </action>
  <verify>Reports display in selected currency</verify>
  <done>Reports support currency conversion.</done>
</task>

<task type="auto">
  <name>Update Account Display for Multi-Currency</name>
  <files>src/components/AccountHierarchy.tsx, src/components/SummaryCards.tsx</files>
  <action>
    1. Show account's native currency
    2. Add option to show all in base currency
    3. Summary cards convert to base currency
    4. Show conversion rate where applicable
  </action>
  <verify>Accounts show correct multi-currency values</verify>
  <done>Account views support multi-currency.</done>
</task>

</tasks>

<verification>
- Currency conversion matches expected rates
- Reports convert correctly
- Manual rate entry works
- Missing rate shows helpful error
</verification>

<success_criteria>
Multi-currency data is properly handled and convertible.
</success_criteria>

<output>
After completion, create `.planning/phases/06-supporting-features/06-02-SUMMARY.md`
</output>
