---
phase: 02-enhanced-transaction-journal
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified: [src/lib/gnucash/guid.ts, src/lib/gnucash/math.ts, src/lib/services/transaction.service.ts, src/app/api/transactions/route.ts, src/app/api/transactions/[guid]/route.ts]
autonomous: true

must_haves:
  truths:
    - "System generates valid 32-char hex GUIDs for new transactions/splits"
    - "System prevents saving transactions where splits do not sum to zero"
    - "Transaction and its splits are saved atomically"
  artifacts:
    - path: "src/lib/gnucash/guid.ts"
      provides: "GnuCash compatible GUID generation"
    - path: "src/lib/gnucash/math.ts"
      provides: "Safe fraction/BigInt arithmetic"
    - path: "src/lib/services/transaction.service.ts"
      provides: "Atomic CRUD operations with validation"
  key_links:
    - from: "src/lib/services/transaction.service.ts"
      to: "Prisma"
      via: "$transaction block"
---

<objective>
Implement the backend infrastructure and services for transaction CRUD operations.

Purpose: Ensure data integrity and double-entry compliance through atomic updates and validation logic.
Output: Core utilities and a robust backend service for creating, updating, and deleting transactions.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-enhanced-transaction-journal/02-RESEARCH.md
@.planning/phases/02-enhanced-transaction-journal/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Implement GnuCash Utilities</name>
  <files>src/lib/gnucash/guid.ts, src/lib/gnucash/math.ts</files>
  <action>
    - guid.ts: Export `generateGnucashGuid()` using `crypto.randomBytes(16).toString('hex')`.
    - math.ts: Export `toDecimal(num, denom)` and `fromDecimal(val, denom)`.
    Ensure `math.ts` handles `BigInt` safely for GnuCash compatibility.
  </action>
  <verify>Run a node script to generate 10 GUIDs and verify they are all 32 hex chars; check fromDecimal(10.50) returns {num: 1050n, denom: 100n}.</verify>
  <done>Core utilities for GUIDs and numeric fractions are available.</done>
</task>

<task type="auto">
  <name>Implement Transaction Service</name>
  <files>src/lib/services/transaction.service.ts</files>
  <action>
    Create a service with the following methods:
    - `createTransaction(data)`: Validates splits sum to zero, generates GUIDs, saves via `prisma.$transaction`.
    - `updateTransaction(guid, data)`: Replaces existing splits with new ones, maintains atomic integrity.
    - `deleteTransaction(guid)`: Removes transaction and its splits.
    
    Add Zod validation for the transaction/split inputs.
  </action>
  <verify>Write a temporary test script or API test that attempts to save an unbalanced transaction and confirms it fails with a specific error.</verify>
  <done>Service layer enforces double-entry rules and atomic updates.</done>
</task>

<task type="auto">
  <name>Expose CRUD API Endpoints</name>
  <files>src/app/api/transactions/route.ts, src/app/api/transactions/[guid]/route.ts</files>
  <action>
    - route.ts: Add POST handler to call `transactionService.createTransaction`.
    - [guid]/route.ts: Create this file with PUT and DELETE handlers.
    
    Ensure appropriate error responses (400 for validation errors, 404 for missing GUID).
  </action>
  <verify>Use Postman or curl to POST a balanced transaction and confirm it appears in the database.</verify>
  <done>API layer provides standard REST endpoints for transaction management.</done>
</task>

</tasks>

<verification>
- GUIDs are exactly 32 lowercase hex characters.
- Unbalanced transactions are rejected by the service.
- POST/PUT/DELETE operations correctly reflect in the database and splits table.
</verification>

<success_criteria>
- No transactions exist in the database with non-zero split totals.
- All database operations for a single transaction happen in a single SQL transaction.
</success_criteria>

<output>
After completion, create `.planning/phases/02-enhanced-transaction-journal/02-02-SUMMARY.md`
</output>
