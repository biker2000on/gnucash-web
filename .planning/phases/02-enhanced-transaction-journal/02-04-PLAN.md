---
phase: 02-enhanced-transaction-journal
plan: 04
type: execute
wave: 4
depends_on: [02, 03]
files_modified: [src/app/api/splits/[guid]/reconcile/route.ts, src/components/ReconcileToggle.tsx, src/components/AccountLedger.tsx]
autonomous: true

must_haves:
  truths:
    - "User can toggle reconciliation status by clicking it in the ledger"
    - "Status cycles: n (none) -> c (cleared) -> y (reconciled)"
    - "Reconciled (y) transactions are locked from editing without confirmation"
  artifacts:
    - path: "src/app/api/splits/[guid]/reconcile/route.ts"
      provides: "Split-specific reconciliation updates"
    - path: "src/components/ReconcileToggle.tsx"
      provides: "Clickable status indicator"
  key_links:
    - from: "src/components/ReconcileToggle.tsx"
      to: "/api/splits/[guid]/reconcile"
      via: "PATCH request"
---

<objective>
Implement the reconciliation workflow for marking transactions as cleared or reconciled.

Purpose: Allow users to track their bank statements against GnuCash data and protect verified data from accidental changes.
Output: Reconciliation status management in API and UI.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-enhanced-transaction-journal/02-02-SUMMARY.md
@.planning/phases/02-enhanced-transaction-journal/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create Reconciliation API</name>
  <files>src/app/api/splits/[guid]/reconcile/route.ts</files>
  <action>
    Create a PATCH endpoint to update a split's `reconcile_state`.
    - Accept `state` ('n', 'c', 'y').
    - If state is 'y', set `reconcile_date` to current timestamp.
    - If state is 'n' or 'c', set `reconcile_date` to null or a distant past date (per GnuCash convention).
  </action>
  <verify>Run `curl -X PATCH -d '{"state":"c"}'` on a split and verify `reconcile_state` in DB becomes 'c'.</verify>
  <done>API allows granular updates to reconciliation status.</done>
</task>

<task type="auto">
  <name>Implement ReconcileToggle Component</name>
  <files>src/components/ReconcileToggle.tsx, src/components/AccountLedger.tsx, src/components/TransactionJournal.tsx</files>
  <action>
    Create a small, clickable status indicator for the ledger/journal:
    - Displays 'n', 'c', or 'y' (or colored icons/dots).
    - Clicking cycles through states.
    - If status is 'y', show a confirmation dialog before allowing changes (protecting reconciled data).
    
    Integrate into the "R" column of `AccountLedger` and `TransactionJournal`.
  </action>
  <verify>Click an 'n' status in the ledger; it turns to 'c'. Click again; it turns to 'y'. Verify DB updates.</verify>
  <done>Users can quickly reconcile transactions directly from the view.</done>
</task>

<task type="auto">
  <name>Lock Reconciled Transactions</name>
  <files>src/components/TransactionEditModal.tsx, src/components/TransactionForm.tsx</files>
  <action>
    Modify the UI to prevent editing if any split in the transaction is marked 'y' (reconciled):
    - "Edit" button in modal should show a warning or be disabled.
    - If editing is allowed (after confirmation), warning should be visible in the form.
  </action>
  <verify>Try to edit a transaction where a split is 'y'; confirm UI warns user or prevents action.</verify>
  <done>Integrity of reconciled data is protected.</done>
</task>

</tasks>

<verification>
- Reconcile status cycles correctly.
- Reconcile date is set when state becomes 'y'.
- UI prevents accidental modification of 'y' splits.
</verification>

<success_criteria>
- User can successfully clear (c) a month of transactions.
- Reconciled status persists and locks the transaction.
</success_criteria>

<output>
After completion, create `.planning/phases/02-enhanced-transaction-journal/02-04-SUMMARY.md`
</output>
